name: TD Full Pipeline (5m)

on:
  workflow_dispatch:
    inputs:
      force_public_sync:
        description: "Kézi futtatáskor is frissítsd a public tartalmat"
        required: false
        default: "true"
  schedule:
    # GitHub Actions only guarantees cron triggers at a minimum 2-minute cadence,
    - cron: "*/2 * * * *" # 2 percenként (UTC)
    - cron: "0 5 * * *" # Napi egyszer 05:00-kor (UTC)

permissions:
  contents: write
  
concurrency:
  # Allow manual dispatches to finish even if a scheduled run starts by
  # separating the concurrency group based on the triggering event.
  # Scheduled runs ("auto") still cancel their predecessors to avoid
  # overlapping cron executions, while manual runs ("manual") can execute
  # independently without being pre-empted by the cron trigger.
  group: td-pipeline-${{ github.ref }}-${{ github.event_name == 'schedule' && 'auto' || 'manual' }}
  cancel-in-progress: true

jobs:
  trading_and_analysis:
    name: 1) Trading.py → Analysis (egy runneren)
    runs-on: ubuntu-24.04
    env:
      TZ: UTC
      OUT_DIR: public
      TD_PAUSE: "0.3"
      TWELVEDATA_API_KEY: ${{ secrets.TWELVEDATA_API_KEY }}
      SESSION_OVERRIDE_24_7: "1"
      PIPELINE_MAX_LAG_SECONDS: "800"
      DISABLE_ML_PROBABILITY: "1"
      ML_PROBABILITY_MANUAL_OVERRIDE: "1"
      RESET_PUBLIC_ON_TRADING_START: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 1

      - name: Sync default branch
        run: |
          git fetch origin main
          git reset --hard origin/main      
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: requirements.lock
          
      - name: Restore Python virtualenv cache
        id: cache-venv
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ hashFiles('requirements.lock') }}
          restore-keys: |
            venv-${{ runner.os }}-

      - name: Create virtualenv (cache miss)
        if: steps.cache-venv.outputs.cache-hit != 'true'
        run: |
          python -m venv .venv
          .venv/bin/python -m pip install --upgrade pip
          .venv/bin/pip install -r requirements.lock

      - name: Activate virtualenv for subsequent steps
        run: |
          echo "VIRTUAL_ENV=$PWD/.venv" >> $GITHUB_ENV
          echo "PATH=$PWD/.venv/bin:$PATH" >> $GITHUB_ENV

      - name: Show sklearn/joblib versions
        run: |
          .venv/bin/python - <<'PY'
          import sklearn, joblib
          print("scikit-learn:", sklearn.__version__)
          print("joblib:", joblib.__version__)
          PY

      - name: Run Trading.py (pull all OHLC + spot)
        run: .venv/bin/python Trading.py
        
      - name: Sync pipeline artifacts into public
        if: github.event_name != 'workflow_dispatch' || github.event.inputs.force_public_sync != 'false'
        env:
          PUBLIC_SYNC_RUN_ID: ${{ github.run_id }}
          PUBLIC_SYNC_COMMIT: ${{ github.sha }}
        run: |
          set -euo pipefail
          .venv/bin/python scripts/update_public.py --target "${OUT_DIR:-public}" \
            --sources data reports \
            --run-id "$PUBLIC_SYNC_RUN_ID" \
            --commit "$PUBLIC_SYNC_COMMIT"

      - name: Verify public sync metadata
        if: github.event_name != 'workflow_dispatch' || github.event.inputs.force_public_sync != 'false'
        env:
          EXPECTED_RUN_ID: ${{ github.run_id }}
        run: |
          set -euo pipefail
          .venv/bin/python - <<'PY'
          from pathlib import Path
          import json
          import sys

          meta_path = Path('public/.sync-metadata.json')
          if not meta_path.exists():
            raise SystemExit("Missing public/.sync-metadata.json after sync")

          metadata = json.loads(meta_path.read_text())
          if metadata.get('run_id') != "${EXPECTED_RUN_ID}":
            raise SystemExit(f"Unexpected run_id in metadata: {metadata.get('run_id')}")

          checksum = metadata.get('checksum')
          if not checksum:
            raise SystemExit("Empty checksum recorded for public sync")

          last_sync = Path('public/.last_sync')
          if not last_sync.exists():
            raise SystemExit("Missing public/.last_sync stamp after sync")

          print("Verified public sync metadata", metadata)
          PY

      - name: Upload pipeline artifact bundle
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-artifacts
          path: |
            data
            reports
            
      - name: Verify model exists & loadable
        run: .venv/bin/python scripts/check_ml_readiness.py BTCUSD

      - name: Run analysis (ML disabled)
        run: |
          .venv/bin/python analysis.py
               
      - name: Generate latency monitoring snapshot
        run: |
          .venv/bin/python scripts/check_latency_sources.py --output public/monitoring/data_latency.json --pretty
               
      - name: Upload analysis outputs
        uses: actions/upload-artifact@v4
        with:
          name: analysis-public
          path: public
  deploy_public:
    name: 2) Deploy refreshed public
    needs:
      - trading_and_analysis
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
    steps:
      - name: Download refreshed public artifact
        uses: actions/download-artifact@v4
        with:
          name: analysis-public
          path: public

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Deploy public folder to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
  notify:
    name: 3) Discord értesítő
    needs:
      - trading_and_analysis
      - deploy_public    
    runs-on: ubuntu-24.04
    env:
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      DISCORD_COOLDOWN_MIN: ${{ secrets.DISCORD_COOLDOWN_MIN }}
      DISCORD_COOLDOWN_MOMENTUM_MIN: ${{ secrets.DISCORD_COOLDOWN_MOMENTUM_MIN }}
    steps:
      - name: Checkout latest signals
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 1

      - name: Sync with latest main
        run: |
          git fetch origin main
          git reset --hard origin/main

      - name: Prepare public directory
        run: |
          rm -rf public
          mkdir -p public

      - name: Download analysis outputs
        uses: actions/download-artifact@v4
        with:
          name: analysis-public
          path: public
               
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: requirements.lock
          
      - name: Restore Python virtualenv cache
        id: cache-venv
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ hashFiles('requirements.lock') }}
          restore-keys: |
            venv-${{ runner.os }}-

      - name: Create virtualenv (cache miss)
        if: steps.cache-venv.outputs.cache-hit != 'true'
        run: |
          python -m venv .venv
          .venv/bin/python -m pip install --upgrade pip
          .venv/bin/pip install -r requirements.lock

      - name: Activate virtualenv for subsequent steps
        run: |
          echo "VIRTUAL_ENV=$PWD/.venv" >> $GITHUB_ENV
          echo "PATH=$PWD/.venv/bin:$PATH" >> $GITHUB_ENV

      - name: Run Discord notifier
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            .venv/bin/python scripts/notify_discord.py --manual
          else
            .venv/bin/python scripts/notify_discord.py
          fi
