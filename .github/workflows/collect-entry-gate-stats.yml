name: Collect entry gate stats

on:
  workflow_dispatch:
    inputs:
      since_date:
        description: "Start date (UTC, YYYY-MM-DD)"
        required: true
        default: "2024-11-14"

jobs:
  collect:
    runs-on: ubuntu-24.04

    permissions:
      actions: read
      contents: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Collect entry gate stats
        env:
          GITHUB_TOKEN: ${{ secrets.ENTRY_GATE_STATS_PAT }}
        run: |
          python tools/collect_entry_gate_stats.py \
            --since-date "${{ github.event.inputs.since_date }}" \
            --workflow-name "TD Full Pipeline (5m)" \
            --branch "main" \
            --max-runs 1000 \
            --verbose

      - name: Upload aggregate JSON
        uses: actions/upload-artifact@v4
        with:
          name: entry-gate-stats-aggregate
          path: public/debug/entry_gate_stats_aggregate_since_*.json
