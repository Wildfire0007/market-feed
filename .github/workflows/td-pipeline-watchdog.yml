name: TD Pipeline Watchdog

on:
  workflow_run:
    workflows:
      - Macro Calendar Lockout
    types:
      - completed
  workflow_dispatch:

permissions:
  actions: write
  contents: read

jobs:
  ensure_td_pipeline_fresh:
    runs-on: ubuntu-24.04
    timeout-minutes: 5
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Check TD pipeline freshness and dispatch if stale
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const workflow_id = 'td-pipeline.yml';
            const maxGapMinutes = 12;
            const maxRunningMinutes = 25;

            const runsResp = await github.rest.actions.listWorkflowRuns({
              owner,
              repo,
              workflow_id,
              branch: 'main',
              per_page: 20,
            });

            const runs = runsResp.data.workflow_runs || [];
            const now = Date.now();
            const inProgress = runs.filter((r) => r.status !== 'completed');
            const latest = runs[0] || null;

            const latestAgeMin = latest
              ? (now - new Date(latest.created_at).getTime()) / 60000
              : Number.POSITIVE_INFINITY;

            const hasHealthyRunning = inProgress.some((r) => {
              const age = (now - new Date(r.created_at).getTime()) / 60000;
              return age <= maxRunningMinutes;
            });

            core.info(`TD latest run age: ${Number.isFinite(latestAgeMin) ? latestAgeMin.toFixed(1) : 'none'} min`);
            core.info(`TD in-progress runs: ${inProgress.length}`);

            if (hasHealthyRunning) {
              core.info('TD pipeline already running in healthy window; no dispatch needed.');
              return;
            }

            if (latestAgeMin <= maxGapMinutes) {
              core.info(`TD pipeline freshness within ${maxGapMinutes} min; no dispatch needed.`);
              return;
            }

            await github.rest.actions.createWorkflowDispatch({
              owner,
              repo,
              workflow_id,
              ref: 'main',
              inputs: {
                force_public_sync: 'true',
              },
            });
            core.notice(`Triggered fallback dispatch for ${workflow_id}; latest age=${latestAgeMin.toFixed(1)} min`);
